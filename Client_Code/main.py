# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file 'C:\Users\60307\Desktop\test.ui'
#
# Created by: PyQt5 UI code generator 5.15.4
#
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.
import base64
import sys, threading
import time

from PyQt5 import QtCore, QtGui, QtWidgets
from datetime import datetime

from png_163 import png_163
from pop3 import POP3
from smtp import SMTP
from PyQt5.QtWidgets import QMainWindow, QPushButton,QTableWidgetItem, QMessageBox
from flanker import mime

pop3 = POP3()
smtp = SMTP()
mutex = threading.Lock()
t = []
usr=''
psw=''
class ui_163_login(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setupUi()

    def setupUi(self):
        icon = QtGui.QIcon()
        icon.addPixmap(QtGui.QPixmap("C:\\Users\\60307\\Desktop\\è®¡ç½‘å®éªŒå¤§ä½œä¸š\\version-2.0\\163.ico"), QtGui.QIcon.Normal,
                       QtGui.QIcon.Off)
        self.setWindowIcon(icon)
        self.setGeometry(700, 300, 500, 500)
        self.setWindowTitle('ç½‘æ˜“163é‚®ç®±ğŸ“«å®¢æˆ·ç«¯')

        self.username_input = QtWidgets.QLineEdit(self)
        self.username_input.setGeometry(QtCore.QRect(80, 170, 331, 41))
        self.username_input.setObjectName("username_input")

        self.password_input = QtWidgets.QLineEdit(self)
        self.password_input.setGeometry(QtCore.QRect(80, 250, 331, 41))
        self.password_input.setObjectName("password_input")

        self.username_label = QtWidgets.QLabel("ç”¨æˆ·å", self)
        self.username_label.setGeometry(QtCore.QRect(10, 180, 51, 21))
        self.username_label.setObjectName("username_label")
        self.password_label = QtWidgets.QLabel("æˆæƒç ", self)
        self.password_label.setGeometry(QtCore.QRect(10, 260, 51, 21))
        self.password_label.setObjectName("password_label")

        self.login_button = QtWidgets.QPushButton("ç™»é™†", self)
        self.login_button.setGeometry(QtCore.QRect(100, 320, 111, 41))
        self.login_button.setObjectName("login_button")

        self.exit_button = QtWidgets.QPushButton("å–æ¶ˆ", self)
        self.exit_button.setGeometry(QtCore.QRect(270, 320, 101, 41))
        self.exit_button.setObjectName("exit_button")
        self.exit_button.clicked.connect(self.close)

        self.login_button.clicked.connect(self.login)

        self.label = QtWidgets.QLabel(self)
        self.label.setGeometry(QtCore.QRect(60, 50, 341, 71))
        self.label.setText("")
        icon = QtGui.QPixmap()
        icon.loadFromData(png_163)
        self.label.setPixmap(icon)
        self.label.setScaledContents(False)
        self.label.setObjectName("label")
        self.show()

    def login(self):
        t = threading.Thread(target=self.loginRun)
        t.start()
        time.sleep(2)
        self.close()

    def loginRun(self):
        mutex.acquire()
        usr=self.username_input.text()
        psw=self.password_input.text()
        pop3.connect('pop.163.com')
        smtp.connect('smtp.163.com')
        for index in range(50):
            t[index].usr=usr
            t[index].psw=psw
        pop3.auth(usr, psw)
        smtp.auth(usr, psw)

        pop3.getAllMail()
        mutex.release()


class Ui_send(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setupUi()

    def setupUi(self):
        icon = QtGui.QIcon()
        icon.addPixmap(QtGui.QPixmap("C:\\Users\\60307\\Desktop\\è®¡ç½‘å®éªŒå¤§ä½œä¸š\\version-2.0\\163.ico"), QtGui.QIcon.Normal,
                       QtGui.QIcon.Off)
        self.setWindowIcon(icon)
        self.setGeometry(600, 300, 290, 150)
        self.setWindowTitle('å‘é‚®ä»¶')
        self.resize(700, 600)

        self.topic_input = QtWidgets.QPlainTextEdit(self)
        self.topic_input.setGeometry(QtCore.QRect(100, 100, 541, 51))
        self.topic_input.setObjectName("topic_input")

        self.content_input = QtWidgets.QPlainTextEdit(self)
        self.content_input.setGeometry(QtCore.QRect(100, 170, 541, 271))
        self.content_input.setObjectName("content_input")

        self.topic_label = QtWidgets.QLabel("ä¸»é¢˜", self)
        self.topic_label.setGeometry(QtCore.QRect(30, 110, 41, 31))
        self.topic_label.setObjectName("topic_label")

        self.content_label = QtWidgets.QLabel("é‚®ä»¶å†…å®¹", self)
        self.content_label.setGeometry(QtCore.QRect(20, 280, 72, 15))
        self.content_label.setObjectName("content_label")

        self.toaddress_input = QtWidgets.QLineEdit(self)
        self.toaddress_input.setGeometry(QtCore.QRect(100, 30, 541, 40))
        self.toaddress_input.setObjectName("toaddress_input")

        self.toaddress_label = QtWidgets.QLabel("æ”¶ä»¶äºº", self)
        self.toaddress_label.setGeometry(QtCore.QRect(20, 50, 72, 15))
        self.toaddress_label.setObjectName("toaddress")

        self.send_button = QtWidgets.QPushButton("å‘é€", self)
        self.send_button.setGeometry(QtCore.QRect(100, 470, 541, 41))
        self.send_button.setObjectName("send_button")

        self.warning_send=Ui_send_warning()
        self.warning_send.pushButton_yes.clicked.connect(self.send)

        self.send_button.clicked.connect(self.warning_send.show)

    def send(self):
        t = threading.Thread(target=self.sendRun, args=())
        t.start()
        self.warning_send.close()

    def sendRun(self):
        mutex.acquire()
        smtp.send_to(self.toaddress_input.text())
        topic = self.topic_input.toPlainText()
        content = self.content_input.toPlainText()
        _=smtp.send_content(topic, "text/plain", content)
        self.mailserver,self.usr,self.psw=smtp.newsmtp()
        print(self.mailserver,self.usr,self.psw)
        try:
            smtp.quit()
        except ConnectionAbortedError:
            smtp.connect(self.mailserver)
            smtp.auth(self.usr,self.psw)
        smtp.connect(self.mailserver)
        smtp.auth(self.usr, self.psw)
        print(_)
        if('OK' in _):
            print('æˆåŠŸå‘é€')
            self.close()
            self.infor(0)
            self.topic_input.clear()
            self.content_input.clear()
            self.toaddress_input.clear()
        else:
            print('è¯·æ£€æŸ¥æ”¶ä»¶åœ°å€æ˜¯å¦æ­£ç¡®')
            self.close()
            self.infor(1)
            self.topic_input.clear()
            self.content_input.clear()
            self.toaddress_input.clear()
        mutex.release()
    def infor(self,m):
        t = threading.Thread(target=self.inforRun, args=(m,))
        t.start()

    def inforRun(self,m):
        mutex.acquire()
        msgBox=QMessageBox()
        if (m == 0):
            msgBox.setText("æˆåŠŸï¼é‚®ä»¶å·²ç»å‘é€æˆåŠŸï¼")
            msgBox.addButton(QMessageBox.Ok)
            msgBox.button(QMessageBox.Ok).hide()
            msgBox.exec()

        elif (m == 1):
            msgBox.setText("é”™è¯¯,å‘é€å¤±è´¥ï¼è¯·æ£€æŸ¥æ”¶ä»¶åœ°å€æ˜¯å¦æ­£ç¡®ï¼")
            msgBox.addButton(QMessageBox.Ok)
            msgBox.button(QMessageBox.Ok).hide()
            msgBox.exec()

        mutex.release()


class Ui_pop3(QMainWindow):
    def __init__(self):
        super().__init__()
        self.readBtns = []
        for i in range(50):
            readBtn = QPushButton("æŸ¥çœ‹")  # æ–°å»ºä¸€ä¸ªæŒ‰é’®
            self.readBtns.append(readBtn)

        self.setupUi()
        self.num=0
    def setupUi(self):
        icon = QtGui.QIcon()
        icon.addPixmap(QtGui.QPixmap("C:\\Users\\60307\\Desktop\\è®¡ç½‘å®éªŒå¤§ä½œä¸š\\version-2.0\\163.ico"), QtGui.QIcon.Normal, QtGui.QIcon.Off)
        self.setWindowIcon(icon)
        self.setObjectName("self")
        self.resize(770, 600)
        self.setWindowTitle('ç½‘æ˜“163é‚®ç®±ğŸ“«')
        self.centralwidget = QtWidgets.QWidget(self)
        self.centralwidget.setObjectName("centralwidget")
        self.pushButton_send = QtWidgets.QPushButton('å‘ä»¶', self.centralwidget)
        self.pushButton_send.setGeometry(QtCore.QRect(370, 10, 91, 51))
        self.pushButton_send.setObjectName("pushButton_send")

        self.label = QtWidgets.QLabel(self.centralwidget)
        self.label.setGeometry(QtCore.QRect(20, 10, 331, 91))
        self.label.setText("")
        icon=QtGui.QPixmap()
        icon.loadFromData(png_163)
        self.label.setPixmap(icon)
        self.label.setObjectName("label")

        self.pushButton_refresh = QtWidgets.QPushButton('åˆ·æ–°', self.centralwidget)
        self.pushButton_refresh.setGeometry(QtCore.QRect(500, 10, 91, 51))
        self.pushButton_refresh.setObjectName("pushButton_refresh")

        self.pushButton_loginout = QtWidgets.QPushButton('ç™»å‡º', self.centralwidget)
        self.pushButton_loginout.setGeometry(QtCore.QRect(630, 10, 91, 51))
        self.pushButton_loginout.setObjectName("pushButton_loginout")

        self.textBrowser = QtWidgets.QTextBrowser(self.centralwidget)
        self.textBrowser.setGeometry(QtCore.QRect(370, 70, 351, 47))
        self.textBrowser.setObjectName("textBrowser")
        self.datetimenow=datetime.now()
        self.textBrowser.setText("ç™»å½•æ—¶é—´ï¼š"+str(self.datetimenow))


        self.tableWidget = QtWidgets.QTableWidget(self.centralwidget)
        self.tableWidget.setEditTriggers(QtWidgets.QTableWidget.NoEditTriggers)
        self.tableWidget.setColumnCount(4)

        self.headers = ['ä¸»é¢˜', 'å‘ä»¶äºº', 'æ—¶é—´', 'æ“ä½œ']
        self.tableWidget.setHorizontalHeaderLabels(self.headers)
        self.tableWidget.setColumnWidth(0, 100)
        self.tableWidget.setColumnWidth(1, 300)
        self.tableWidget.setColumnWidth(2, 240)
        self.tableWidget.setColumnWidth(3, 50)

        self.tableWidget.setGeometry(QtCore.QRect(20, 140, 711, 411))
        self.tableWidget.setObjectName("tableWidget")

        self.setCentralWidget(self.centralwidget)
        self.statusbar = QtWidgets.QStatusBar(self)
        self.statusbar.setObjectName("statusbar")
        self.setStatusBar(self.statusbar)
        self.pushButton_refresh.clicked.connect(self.refresh)

    def loginout(self):
        t = threading.Thread(target=self.loginoutRun, args=())
        t.start()
        self.close()
    def loginoutRun(self):
        smtp.quit()
        pop3.quit()

    def show_refresh(self):
        time.sleep(0.5)
        self.refresh()
        self.show()
    def add_button(self,num):

        for index in range(num):
            t[index].index = index
            self.readBtns[index].setDown(True)
            self.readBtns[index].setStyleSheet("QPushButton{margin:3px};")
            self.tableWidget.setCellWidget(index, 3, self.readBtns[index])  # æ·»åŠ æŒ‰é’®åˆ°åˆ—è¡¨ï¼ˆ0ï¼Œ2ï¼‰
    def refresh(self):
        self.mailserver,self.usr,self.psw=pop3.newpop3()
        pop3.quit()
        pop3.connect(self.mailserver)
        pop3.auth(self.usr,self.psw)
        pop3.getAllMail()
        print(pop3.getStat())
        t = threading.Thread(target=self.refreshRun)
        t.start()
        len_mail_list=pop3.getStat()
        print(len_mail_list,'å½“å‰æ•°é‡')
        time.sleep(1)
        self.datetimenow=datetime.now()
        t,_=str(self.datetimenow).split('.')
        self.textBrowser.setText("ä¸Šæ¬¡åˆ·æ–°æ—¶é—´ï¼š" + t)
        self.textBrowser.append("æ¬¢è¿è®¿é—®ç½‘æ˜“163é‚®ç®±ğŸ“«ï¼")
        self.add_button(len_mail_list)


    def refreshRun(self):
        mutex.acquire()
        time.sleep(1)
        mail_list = pop3.mailList
        print('loginåçš„åˆå§‹å€¼',mail_list)
        mail_list_mime = []

        for item in mail_list:
            m = mime.from_string(item)
            mail_list_mime.append(m)
        mail_list_headers = []
        for item in mail_list_mime:
            headers = item.headers.items()
            mail_list_headers.append(headers)
        print(mail_list_headers)
        num_mails = len(mail_list)  # è®¾ç½®æ€»ä¿¡ä»¶æ•°
        self.old_num=num_mails
        self.tableWidget.setRowCount(num_mails)
        print(num_mails)
        for index in range(len(mail_list_headers)):
            t = mail_list_headers[index]
            for item in t:
                if (item[0] == "Date"):
                    sendtime = item[1]  # æ—¶é—´
                elif (item[0] == "From"):
                    sendfrom = item[1]  # å‘ä»¶äºº
                elif (item[0] == "Subject"):
                    subject = item[1]  # å‘ä»¶äºº
                elif (item[0] == "To"):
                    self.usr = item[1]  # æ”¶ä»¶äºº
            self.tableWidget.setItem(index, 0, QTableWidgetItem(subject))  # ä¸»é¢˜
            self.tableWidget.setItem(index, 1, QTableWidgetItem(sendfrom))  # å‘ä»¶äºº
            self.tableWidget.setItem(index, 2, QTableWidgetItem(sendtime))  # æ—¶é—´
        mutex.release()


class Ui_content(QMainWindow):
    def __init__(self):
        super().__init__()
        self.usr=''
        self.psw=''
        self.index=0

    def show_this(self):
        self.setupUi()
        self.show()
    def setupUi(self):
        self.setWindowTitle('é‚®ä»¶å†…å®¹ ğŸ“§')
        icon = QtGui.QIcon()
        icon.addPixmap(QtGui.QPixmap("C:\\Users\\60307\\Desktop\\è®¡ç½‘å®éªŒå¤§ä½œä¸š\\version-2.0\\163.ico"), QtGui.QIcon.Normal,
                       QtGui.QIcon.Off)
        self.setWindowIcon(icon)
        pop3.connect("pop.163.com")
        pop3.auth(self.usr,self.psw)
        print(self.index,'ç¬¬å‡ å°ä¿¡')
        pop3.getAllMail()
        self.mail=pop3.mailList[self.index]
        self.mail_mime=mime.from_string(self.mail)
        self.headers=self.mail_mime.headers.items()
        for item in self.headers:
            print(item[0])
            if(item[0]=="Date"):
                self.sendtime = item[1]  # æ—¶é—´
            elif(item[0]=="From"):
                self.sendfrom = item[1]  # å‘ä»¶äºº
            elif (item[0] == "Subject"):
                self.subject = item[1]  # å‘ä»¶äºº
        print(self.sendfrom,self.sendtime)
        self.setObjectName("MainWindow")
        self.resize(1007, 600)
        self.centralwidget = QtWidgets.QWidget(self)
        self.centralwidget.setObjectName("centralwidget")
        self.pushButton_delete = QtWidgets.QPushButton('åˆ é™¤é‚®ä»¶',self.centralwidget)
        self.pushButton_delete.setGeometry(QtCore.QRect(760, 20, 93, 41))
        self.pushButton_delete.setObjectName("pushButton_delete")

        self.warning_del=Ui_del()
        self.pushButton_delete.clicked.connect(self.warning_del.show)
        self.warning_del.pushButton_yes.clicked.connect(self.dele)

        self.pushButton_close = QtWidgets.QPushButton('é€€å‡ºé˜…è¯»',self.centralwidget)
        self.pushButton_close.setGeometry(QtCore.QRect(870, 20, 93, 41))
        self.pushButton_close.setObjectName("pushButton_close")
        self.pushButton_close.clicked.connect(self.close)

        self.textBrowser_content = QtWidgets.QTextBrowser(self.centralwidget)
        self.textBrowser_content.setGeometry(QtCore.QRect(30, 80, 941, 471))
        self.textBrowser_content.setObjectName("textBrowser_content")
        if(self.mail_mime.content_type.is_multipart()):
            contents=''
            for part in self.mail_mime.parts:
                contents += part.body
            self.textBrowser_content.setText("<h1>ä¸»é¢˜ï¼š" + self.subject + "</h1>")
            self.textBrowser_content.append("å†…å®¹ï¼š"+contents)
        elif(self.mail_mime.content_type.is_singlepart()):
            self.textBrowser_content.setText("<h1>ä¸»é¢˜ï¼š"+self.subject+"</h1>")
            self.textBrowser_content.append("å†…å®¹ï¼š"+self.mail_mime.body)

        self.textBrowser_from = QtWidgets.QTextBrowser(self.centralwidget)
        self.textBrowser_from.setGeometry(QtCore.QRect(100, 20, 251, 50))
        self.textBrowser_from.setObjectName("textBrowser_from")
        self.textBrowser_from.setText(self.sendfrom)

        self.label_from = QtWidgets.QLabel('é‚®ä»¶æ¥è‡ª',self.centralwidget)
        self.label_from.setGeometry(QtCore.QRect(20, 40, 72, 15))
        self.label_from.setObjectName("label_from")

        self.label_time = QtWidgets.QLabel('å‘é€æ—¶é—´',self.centralwidget)
        self.label_time.setGeometry(QtCore.QRect(380, 40, 72, 15))
        self.label_time.setObjectName("label_time")

        self.textBrowser_time = QtWidgets.QTextBrowser(self.centralwidget)
        self.textBrowser_time.setGeometry(QtCore.QRect(450, 20, 251, 50))
        self.textBrowser_time.setObjectName("textBrowser_time")
        self.textBrowser_time.setText(self.sendtime)

        self.setCentralWidget(self.centralwidget)
        self.statusbar = QtWidgets.QStatusBar(self)
        self.statusbar.setObjectName("statusbar")
        self.setStatusBar(self.statusbar)
    def dele(self):
        t = threading.Thread(target=self.deleRun)
        t.start()
        self.warning_del.close()
        self.close()
    def deleRun(self):
        mutex.acquire()
        print(self.index,'åˆ é™¤ç¬¬å‡ ä¸ª')
        pop3.delete(self.index)
        time.sleep(1)
        mutex.release()

class Ui_del(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setupUi()
    def setupUi(self):
        icon = QtGui.QIcon()
        icon.addPixmap(QtGui.QPixmap("C:\\Users\\60307\\Desktop\\è®¡ç½‘å®éªŒå¤§ä½œä¸š\\version-2.0\\163.ico"), QtGui.QIcon.Normal,
                       QtGui.QIcon.Off)
        self.setWindowIcon(icon)
        self.setObjectName("self")
        self.resize(328, 157)
        self.centralwidget = QtWidgets.QWidget(self)
        self.centralwidget.setObjectName("centralwidget")
        self.label = QtWidgets.QLabel('ç¡®å®šè¦åˆ é™¤è¯¥é‚®ä»¶ï¼Ÿ',self.centralwidget)
        self.label.setGeometry(QtCore.QRect(100, 30, 131, 31))
        self.label.setObjectName("label")
        self.pushButton_yes = QtWidgets.QPushButton('ç¡®å®š',self.centralwidget)
        self.pushButton_yes.setGeometry(QtCore.QRect(30, 80, 71, 41))
        self.pushButton_yes.setObjectName("pushButton_yes")

        self.pushButton_no = QtWidgets.QPushButton('å–æ¶ˆ',self.centralwidget)
        self.pushButton_no.setGeometry(QtCore.QRect(210, 80, 71, 41))
        self.pushButton_no.setObjectName("pushButton_no")
        self.pushButton_no.clicked.connect(self.close)
        self.setCentralWidget(self.centralwidget)
        self.statusbar = QtWidgets.QStatusBar(self)
        self.statusbar.setObjectName("statusbar")
        self.setStatusBar(self.statusbar)

class Ui_send_warning(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setupUi()
    def setupUi(self):
        icon = QtGui.QIcon()
        icon.addPixmap(QtGui.QPixmap("C:\\Users\\60307\\Desktop\\è®¡ç½‘å®éªŒå¤§ä½œä¸š\\version-2.0\\163.ico"), QtGui.QIcon.Normal,
                       QtGui.QIcon.Off)
        self.setWindowIcon(icon)
        self.setObjectName("self")
        self.resize(328, 157)
        self.centralwidget = QtWidgets.QWidget(self)
        self.centralwidget.setObjectName("centralwidget")
        self.label = QtWidgets.QLabel('ç¡®å®šè¦å‘é€è¯¥é‚®ä»¶ï¼Ÿ',self.centralwidget)
        self.label.setGeometry(QtCore.QRect(100, 30, 131, 31))
        self.label.setObjectName("label")
        self.pushButton_yes = QtWidgets.QPushButton('ç¡®å®š',self.centralwidget)
        self.pushButton_yes.setGeometry(QtCore.QRect(30, 80, 71, 41))
        self.pushButton_yes.setObjectName("pushButton_yes")

        self.pushButton_no = QtWidgets.QPushButton('å–æ¶ˆ',self.centralwidget)
        self.pushButton_no.setGeometry(QtCore.QRect(210, 80, 71, 41))
        self.pushButton_no.setObjectName("pushButton_no")
        self.pushButton_no.clicked.connect(self.close)
        self.setCentralWidget(self.centralwidget)
        self.statusbar = QtWidgets.QStatusBar(self)
        self.statusbar.setObjectName("statusbar")
        self.setStatusBar(self.statusbar)

if __name__ == "__main__":
    png_163 = base64.b64decode(png_163)
    app = QtWidgets.QApplication(sys.argv)
    for index in range(50):
        t.append(Ui_content())
    window_163_login = ui_163_login()
    window_163_login.show()
    send_window = Ui_send()
    pop3_window = Ui_pop3()
    window_163_login.login_button.clicked.connect(pop3_window.show_refresh)
    pop3_window.pushButton_send.clicked.connect(send_window.show)
    pop3_window.pushButton_loginout.clicked.connect(pop3_window.loginout)
    for index in range(50):
        pop3_window.readBtns[index].clicked.connect(t[index].show_this)
    sys.exit(app.exec_())
